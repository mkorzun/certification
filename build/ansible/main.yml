---
- hosts: localhost
  gather_facts: False
  tasks:
  - name: run ssh-keyscan to add keys to known_hosts
    shell: ssh-keyscan -H {{ hostvars }} >> ~/.ssh/known_hosts
- hosts: build
  gather_facts: no
  become: yes
  tasks:
  - name: Install docker and some dependencies
    apt:
     name: python3-pip, docker.io
     state: present
     update_cache: yes
  - name: Start docker service
    service:
     name: docker
     state: started
  - name: Install docker python module
    pip:
     name: docker
  - name: Example clone of a single branch
    ansible.builtin.git:
      repo: https://github.com/snuffles765/certification.git
      dest: /tmp/project
      single_branch: yes
      version: master
  - name: Build container image
    docker_image:
      name: myboxfuseimage:{{version}}
      build:
        path: /tmp/project/build/ansible/files
      state: present
  - name: Log into DockerHub
    community.docker.docker_login:
      username: {{docker_hub_login}}
      password: {{docker_hub_password}}
  - name: Tag and push to docker hub
    community.docker.docker_image:
      name: myboxfuseimage:{{version}}
      repository: kmi8652/myboxfuseimage:{{version}}
      push: yes
      source: local
  - name: Remove image
    docker_image:
      state: absent
      name: kmi8652/myboxfuseimage:{{version}}
  - name: Remove image
    docker_image:
      state: absent
      name: myboxfuseimage:{{version}}